name: triggerPublishToNpm

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag name (gnowth@*)
        required: true

      environment:
        description: Environment to deploy to (DEV/sit/uat/prod)
        default: dev
        required: false

env:
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  # Phase 0: Branch check
  check_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Cancelling - Branch must either be a main/release branch
        if: ${{ github.ref != 'refs/heads/main' && !startsWith( github.ref, 'refs/heads/release-' ) }}
        uses: andymckay/cancel-action@0.2

      - name: Cancelling - Input [Tag name] is invalid
        if: ${{ !startsWith( github.event.inputs.tag, 'gnowth@' ) }}
        uses: andymckay/cancel-action@0.2

      - name: Cancelling - Input [Environment] is invalid
        if: ${{ github.event.inputs.environment != 'dev' && github.event.inputs.environment != 'sit' && github.event.inputs.environment != 'uat' && github.event.inputs.environment != 'prod' }}
        uses: andymckay/cancel-action@0.2

  # Phase 1: Publish
  publish:
    container: node:16.4.0-buster-slim
    needs: check_branch
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifact
        uses: dsaltares/fetch-gh-release-asset@0.06
        with:
          version: tags/${{ github.event.inputs.tag }}
          file: artifact.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extracting artifact
        uses: montudor/action-zip@v1
        with:
          args: unzip -qq artifact.zip -d .

      - name: Generate .npmrc file
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ./.npmrc

      - name: Publish
        if: github.event.inputs.environment == 'prod'
        run: npm run ci:publish
